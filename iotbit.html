<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>IoT Bit – Visor de Datos</title>

<style>
body {
  background: #e9f0f7;
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 20px;
}

.card {
  background: #ffffff;
  padding: 20px;
  border-radius: 12px;
  max-width: 500px;
  margin: 0 auto;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  color: #1d3557;
}

.stat {
  background: #ffffff;
  border: 2px solid #d2e3f1;
  border-radius: 10px;
}

.stat-label {
  color: #457b9d;
}


  .stat-label {
    font-size: 12px;
    color: #444;
  }

  .stat-value {
    font-size: 22px;
    margin-top: 5px;
  }

  #timestamp {
    margin-top: 15px;
    text-align: center;
    font-size: 14px;
    color: #333;
  }
</style>
</head>

<body>

<div class="card">
  <h2>Última lectura — Canal ThingSpeak 3160844</h2>

  <!-- Datos -->
  <div id="values"></div>

  <!-- Fecha y hora -->
  <div id="timestamp"></div>

  <!-- Error -->
  <div id="errorBox"
       style="display:none;background:#fee2e2;color:#991b1b;padding:12px;margin-top:16px;
       border-radius:8px;text-align:center;">
  </div>
</div>

<!-- TU SCRIPT -->
<script>
document.addEventListener("DOMContentLoaded", () => {

  const channelId = 3160844;
  const fields = [1, 2, 3];

  function ensureErrorBox() {
    let box = document.getElementById("errorBox");
    return box;
  }

  function saveLastGood(entry) {
    try {
      localStorage.setItem("lastGoodReading", JSON.stringify(entry));
    } catch {}
  }

  function loadLastGood() {
    try {
      const data = localStorage.getItem("lastGoodReading");
      return data ? JSON.parse(data) : null;
    } catch {
      return null;
    }
  }

  async function fetchWithFallback(url) {
  const proxies = [
    `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
    `https://thingproxy.freeboard.io/fetch/${url}`,
    `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`
  ];

  for (let proxy of proxies) {
    try {
      const response = await fetch(proxy + "&t=" + Date.now());
      if (!response.ok) throw new Error("HTTP " + response.status);

      let text = await response.text();

      // AllOrigins "get" devuelve un JSON dentro de otro JSON
      try {
        if (text.includes('"contents"')) {
          const wrap = JSON.parse(text);
          text = wrap.contents;
        }
      } catch {}

      return JSON.parse(text);
    } catch (e) {
      console.warn("Proxy falló:", proxy, e.message);
      continue;
    }
  }

  throw new Error("Todos los proxies fallaron");
}

async function fetchLastEntry() {
  const url = `https://api.thingspeak.com/channels/${channelId}/feeds/last.json`;
  return await fetchWithFallback(url);
}

  }

  function render(entry) {
    document.getElementById("errorBox").style.display = "none";

    const container = document.getElementById("values");
    container.innerHTML = "";

    fields.forEach(f => {
      const value = entry[`field${f}`] ?? "—";
      const div = document.createElement("div");
      div.className = "stat";
      div.innerHTML = `
        <div class='stat-label'>Field ${f}</div>
        <div class='stat-value'>${value}</div>
      `;
      container.appendChild(div);
    });

    document.getElementById("timestamp").textContent =
      "Hora: " + new Date(entry.created_at).toLocaleString();
  }

  function renderError(message) {
    const box = document.getElementById("errorBox");
    box.style.display = "block";
    box.textContent = "⚠️ " + message;
  }

  async function update() {
    try {
      const data = await fetchLastEntry();
      render(data);
      saveLastGood(data);
    } catch (err) {
      renderError(err.message);

      const lastGood = loadLastGood();
      if (lastGood) {
        render(lastGood);
      } else {
        document.getElementById("values").innerHTML = "";
        document.getElementById("timestamp").textContent = "";
      }
    }
  }

  update();
  setInterval(update, 60000);

});
</script>

</body>
</html>
